---
title: "不真面目回答の効果検証"
author: "Your Name"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# 不真面目回答に対するLLMを活用したナッジ介入の効果の検討：クラウドソーシングを用いて


## ライブラリの読み込み
```{r load-libraries}
pacman::p_load(
  tidyverse,
  ggplotgui,#ggplot_shiny(exdataset)
  GGally,
  broom,
  kableExtra,
  ### table1を表にしてまとめやすく
  table1,
  sjPlot
)
``` 
# データ前処理
5つのデータセットを読み込み、基本データセットから必要なカラムを抽出して一つの新しいデータフレームを作成します。
## データの読み込み
```{r load-data}
# 各データセットの読み込み
basic <- read_csv("../data/basic_2025-10-24.csv")
gain_emphasis <- read_csv("../data/gain_emphasis_2025-10-24.csv")
loss_aversion <- read_csv("../data/loss_aversion_2025-10-24.csv")
pre_commitment <- read_csv("../data/pre_commitment_2025-10-24.csv")
using_llm <- read_csv("../data/using_llm_2025-10-24.csv")
``` 

## データの加工
必要な列のみ抽出

### basicデータの加工
```{r create-basic-df}
# basicデータから必要なカラムを抽出してbasic_dfを作成
basic_df <- basic %>%
  select(
    participant.id_in_session,
    participant._index_in_pages,
    participant.time_started_utc,
    starts_with("player.q_"),  # player.q_gender, player.q_age, etc.
    starts_with("player.big5_"), # BigFive関連
    starts_with("player.inboron"), # 陰謀論関連
    starts_with("player.crt_")   # CRT関連
  ) %>%
  mutate(category = "basic")  # categoryカラムを追加

# basic_dfの先頭6行を表示
head(basic_df)
```

### gain_emphasisデータの加工
```{r create-gain-emphasis-df}
# gain_emphasisデータから必要なカラムを抽出してgain_emphasis_dfを作成
gain_emphasis_df <- gain_emphasis %>%
  select(
    participant.id_in_session,
    participant._index_in_pages,
    participant.time_started_utc,
    starts_with("player.q_"),  # player.q_gender, player.q_age, etc.
    starts_with("player.big5_"), # BigFive関連
    starts_with("player.inboron"), # 陰謀論関連
    starts_with("player.crt_")   # CRT関連
  ) %>%
  mutate(category = "gain_emphasis")  # categoryカラムを追加

# gain_emphasis_dfの先頭6行を表示
head(gain_emphasis_df)
```

### loss_aversionデータの加工
```{r create-loss-aversion-df}
# loss_aversionデータから必要なカラムを抽出してloss_aversion_dfを作成
loss_aversion_df <- loss_aversion %>%
  select(
    participant.id_in_session,
    participant._index_in_pages,
    participant.time_started_utc,
    starts_with("player.q_"),  # player.q_gender, player.q_age, etc.
    starts_with("player.big5_"), # BigFive関連
    starts_with("player.inboron"), # 陰謀論関連
    starts_with("player.crt_")   # CRT関連
  ) %>%
  mutate(category = "loss_aversion")  # categoryカラムを追加

# loss_aversion_dfの先頭6行を表示
head(loss_aversion_df)
```

### pre_commitmentデータの加工
```{r create-pre-commitment-df}
# pre_commitmentデータから必要なカラムを抽出してpre_commitment_dfを作成
pre_commitment_df <- pre_commitment %>%
  select(
    participant.id_in_session,
    participant._index_in_pages,
    participant.time_started_utc,
    starts_with("player.q_"),  # player.q_gender, player.q_age, etc.
    starts_with("player.big5_"), # BigFive関連
    starts_with("player.inboron"), # 陰謀論関連
    starts_with("player.crt_")   # CRT関連
  ) %>%
  mutate(category = "pre_commitment")  # categoryカラムを追加

# pre_commitment_dfの先頭6行を表示
head(pre_commitment_df)
```

### using_llmデータの加工
```{r create-using-llm-df}
# using_llmデータから必要なカラムを抽出してusing_llm_dfを作成
using_llm_df <- using_llm %>%
  select(
    participant.id_in_session,
    participant._index_in_pages,
    participant.time_started_utc,
    starts_with("player.q_"),  # player.q_gender, player.q_age, etc.
    starts_with("player.big5_"), # BigFive関連
    starts_with("player.inboron"), # 陰謀論関連
    starts_with("player.crt_")   # CRT関連
  ) %>%
  mutate(category = "using_llm")  # categoryカラムを追加

# using_llm_dfの先頭6行を表示
head(using_llm_df)
```

## 全データの結合

```{r combine-all-data}
# 5つのデータフレームを結合してall_dataを作成
all_data <- bind_rows(
  basic_df,
  gain_emphasis_df,
  loss_aversion_df,
  pre_commitment_df,
  using_llm_df
)

# all_dataの概要確認
cat("総行数:", nrow(all_data), "行\n総列数:", ncol(all_data), "列\n")

# categoryを日本語ラベルに変更
all_data <- all_data %>%
  mutate(category = factor(category,
                          levels = c("basic", "gain_emphasis", "loss_aversion", "pre_commitment", "using_llm"),
                          labels = c("統制群", "利得強調", "損失回避", "事前申告", "LLM活用")))

``` 


## DQSのダミー列を作成
3つのDQSそれぞれで違反してないなら0、それ以外なら1とする
```{r}
# DQS_1カラムを追加（player.big5_IMCが5なら0、それ以外は1）
all_data <- all_data %>%
  mutate(DQS_1 = ifelse(player.big5_IMC == 5, 0, 1))

# DQS_2カラムを追加（player.inboronIMCが4なら0、それ以外は1）
all_data <- all_data %>%
  mutate(DQS_2 = ifelse(player.inboronIMC == 4, 0, 1))

# DQS_3カラムを追加（player.crt_DQSが27なら0、それ以外は1）
all_data <- all_data %>%
  mutate(DQS_3 = ifelse(player.crt_DQS == 27, 0, 1))



# DQSカラムの分布確認
dqs1_table <- table(all_data$DQS_1, useNA = "always")
dqs2_table <- table(all_data$DQS_2, useNA = "always")
dqs3_table <- table(all_data$DQS_3, useNA = "always")

cat("=== DQS分布確認 ===\nDQS_1 - 真面目:", dqs1_table["0"], ", 不真面目:", dqs1_table["1"], ", NA:", dqs1_table[is.na(names(dqs1_table))], 
    "\nDQS_2 - 真面目:", dqs2_table["0"], ", 不真面目:", dqs2_table["1"], ", NA:", dqs2_table[is.na(names(dqs2_table))],
    "\nDQS_3 - 真面目:", dqs3_table["0"], ", 不真面目:", dqs3_table["1"], ", NA:", dqs3_table[is.na(names(dqs3_table))], "\n")

```

### 0が真面目回答者、1が不真面目回答者と定義する。（NAは途中離脱者）
```{r}
# Or_DQSカラムを追加（DQS_1, DQS_2, DQS_3のいずれかが1なら1、すべて0なら0）
all_data <- all_data %>%
  mutate(Or_DQS = ifelse(DQS_1 == 1 | DQS_2 == 1 | DQS_3 == 1, 1, 0))


or_dqs_table <- table(all_data$Or_DQS, useNA = "always")

cat("=== Or_DQS の分布 ===\n
    真面目回答者 (0):", or_dqs_table["0"], "人, \n
    不真面目回答者 (1):", or_dqs_table["1"], "人, \n
    途中離脱者 (NA):", or_dqs_table[is.na(names(or_dqs_table))], "人, \n
    総計:", sum(or_dqs_table), "人\n")

```

## DQS指標別クロス集計
```{r}
# 不真面目回答者数テーブル（介入群 × DQS指標）
dishonest_table <- all_data %>%
  group_by(category) %>%
  summarise(
    DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
    DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
    DQS_3 = sum(DQS_3 == 1, na.rm = TRUE),
    Or_DQS = sum(Or_DQS == 1, na.rm = TRUE)
  )

cat("=== 不真面目回答者数 ===\n")
print(dishonest_table)
```



```{r dqs-crosstab}
# 真面目回答者数テーブル（介入群 × DQS指標）
honest_table <- all_data %>%
  group_by(category) %>%
  summarise(
    DQS_1 = sum(DQS_1 == 0, na.rm = TRUE),
    DQS_2 = sum(DQS_2 == 0, na.rm = TRUE),
    DQS_3 = sum(DQS_3 == 0, na.rm = TRUE),
    Or_DQS = sum(Or_DQS == 0, na.rm = TRUE)
  )

cat("=== 真面目回答者数 ===\n")
print(honest_table)
```

## DQS指標別違反者数の折れ線グラフ
```{r dqs-violation-plot}
# macOS用日本語フォント設定
theme_set(theme_minimal(base_family = "HiraginoSans-W3"))

# データ準備（違反者数をカウント）
dqs_data <- all_data %>%
  group_by(category) %>%
  summarise(DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
            DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
            DQS_3 = sum(DQS_3 == 1, na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("DQS_"), names_to = "DQS", values_to = "count")

# 折れ線グラフ
ggplot(dqs_data, aes(x = DQS, y = count, color = category, group = category)) +
  geom_line() + geom_point() +
  scale_y_continuous(limits = c(0, NA), breaks = seq(0, 200, 5)) +
  labs(title = "DQS指標別違反者数", x = "DQS指標", y = "違反者数（人）", color = "介入群") +
  theme(text = element_text(family = "HiraginoSans-W3"))
```

## DQS1~3の違反者数推移グラフ
```{r dqs-trend-plot}
# DQS1~3の違反者数推移（全体）
dqs_trend_data <- all_data %>%
  summarise(DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
            DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
            DQS_3 = sum(DQS_3 == 1, na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("DQS_"), names_to = "DQS", values_to = "count") %>%
  mutate(DQS = factor(DQS, levels = c("DQS_1", "DQS_2", "DQS_3")))

# 違反者数を確認
cat("=== DQS指標別違反者数 ===\n")
print(dqs_trend_data)

# 折れ線グラフ（DQS1~3の推移）
ggplot(dqs_trend_data, aes(x = DQS, y = count, group = 1)) +
  geom_line(color = "red", size = 1) + 
  geom_point(color = "red", size = 3) +
  geom_text(aes(label = count), vjust = -1, color = "black", size = 4) +
  scale_y_continuous(limits = c(0, max(dqs_trend_data$count) * 1.1), breaks = seq(0, 200, 10)) +
  labs(title = "DQS指標別違反者数の推移", 
       x = "DQS指標", y = "違反者数（人）") +
  theme(text = element_text(family = "HiraginoSans-W3"))
```

--- 

# こっからをつかう！

## ダミー回帰用データの作成
途中で回答を中断しているデータを除外する
```{r create-dummy-data}
# データ除外前の行数を確認
cat("=== データ除外前の行数 ===\n", 
    "除外前の総行数:", nrow(all_data), "行\n")

# player.crt_rankがNAの行数を確認
na_count <- sum(is.na(all_data$player.crt_rank))
cat("player.crt_rankがNAの行数:", na_count, "行\n")

# player.crt_rankがNAの行を除外
dummy_all_data <- all_data %>%
  filter(!is.na(player.crt_rank)) %>%  # player.crt_rankがNAの行を除外
  mutate(
    # 各カテゴリのダミー変数を作成（日本語ラベルとの比較）
    basic = ifelse(category == "統制群", 1, 0),
    gain_emphasis = ifelse(category == "利得強調", 1, 0),
    loss_aversion = ifelse(category == "損失回避", 1, 0),
    pre_commitment = ifelse(category == "事前申告", 1, 0),
    using_llm = ifelse(category == "LLM活用", 1, 0)
  )

# データ除外後の情報確認
cat("\n=== データ除外後の情報 ===\n", 
    "除外後の総行数:", nrow(dummy_all_data), "行\n", 
    "除外された行数:", nrow(all_data) - nrow(dummy_all_data), "行\n")

# ダミー変数の分布確認
cat("\n=== ダミー変数のデータ数の確認 ===\n", 
    "basic:", sum(dummy_all_data$basic), "行\n", 
    "gain_emphasis:", sum(dummy_all_data$gain_emphasis), "行\n", 
    "loss_aversion:", sum(dummy_all_data$loss_aversion), "行\n", 
    "pre_commitment:", sum(dummy_all_data$pre_commitment), "行\n", 
    "using_llm:", sum(dummy_all_data$using_llm), "行\n")

# ダミー回帰用データでのDQS分布確認
dummy_dqs1_table <- table(dummy_all_data$DQS_1, useNA = "always")
dummy_dqs2_table <- table(dummy_all_data$DQS_2, useNA = "always")
dummy_dqs3_table <- table(dummy_all_data$DQS_3, useNA = "always")
dummy_or_dqs_table <- table(dummy_all_data$Or_DQS, useNA = "always")

cat("\n=== ダミー回帰用データのDQS分布確認 ===\n")
cat("DQS_1 - 真面目:", dummy_dqs1_table["0"], ", 不真面目:", dummy_dqs1_table["1"], ", NA:", dummy_dqs1_table[is.na(names(dummy_dqs1_table))], "\n")
cat("DQS_2 - 真面目:", dummy_dqs2_table["0"], ", 不真面目:", dummy_dqs2_table["1"], ", NA:", dummy_dqs2_table[is.na(names(dummy_dqs2_table))], "\n")
cat("DQS_3 - 真面目:", dummy_dqs3_table["0"], ", 不真面目:", dummy_dqs3_table["1"], ", NA:", dummy_dqs3_table[is.na(names(dummy_dqs3_table))], "\n")
cat("Or_DQS - 真面目:", dummy_or_dqs_table["0"], ", 不真面目:", dummy_or_dqs_table["1"], ", NA:", dummy_or_dqs_table[is.na(names(dummy_or_dqs_table))], "\n")

# 不真面目回答率の計算
dummy_dqs1_rate <- round(mean(dummy_all_data$DQS_1, na.rm = TRUE) * 100, 2)
dummy_dqs2_rate <- round(mean(dummy_all_data$DQS_2, na.rm = TRUE) * 100, 2)
dummy_dqs3_rate <- round(mean(dummy_all_data$DQS_3, na.rm = TRUE) * 100, 2)
dummy_or_dqs_rate <- round(mean(dummy_all_data$Or_DQS, na.rm = TRUE) * 100, 2)

cat("\n=== ダミー回帰用データの不真面目回答率 ===\n")
cat("DQS_1 不真面目回答率:", dummy_dqs1_rate, "%\n")
cat("DQS_2 不真面目回答率:", dummy_dqs2_rate, "%\n")
cat("DQS_3 不真面目回答率:", dummy_dqs3_rate, "%\n")
cat("Or_DQS 不真面目回答率:", dummy_or_dqs_rate, "%\n")
```



```{r save-dummy-data}
# dummy_all_dataをCSVファイルとして出力
#write_csv(dummy_all_data, "../data/dummy_all_data_processed.csv")
#cat("\n=== CSVファイル出力完了 ===\n")
#cat("ファイル名: dummy_all_data_processed.csv\n")
#cat("保存場所: ../data/\n")
```



```{r category-dishonest-rates}
# カテゴリごとの不真面目回答の割合
dummy_all_data %>%
  group_by(category) %>%
  summarise(
    n = n(),
    dishonest_count = sum(Or_DQS, na.rm = TRUE),
    dishonest_rate = round(mean(Or_DQS, na.rm = TRUE) * 100, 1)
  ) %>%
  mutate(dishonest_pct = paste0(dishonest_rate, "%")) %>%
  select(category, n, dishonest_count, dishonest_pct) %>%
  kable(col.names = c("実験条件", 
                      "サンプル数", 
                      "不真面目回答者数", 
                      "不真面目回答率"),
        caption = "実験条件別の不真面目回答者の割合") %>%
  kable_styling()
```


## 記述統計量（不真面目回答者の割合）
```{r descriptive-statistics}
# table1を使った記述統計量表の作成（countと割合を表示）
table1(~ Or_DQS + DQS_1 + DQS_2 + DQS_3 | category, 
       data = dummy_all_data,
       render.categorical = "FREQ (PCTnoNA%)",
       caption = "実験条件別記述統計量")
```

## ダミー回帰用データでのDQS指標別クロス集計
```{r dummy-dqs-crosstab}
# 不真面目回答者数テーブル（介入群 × DQS指標）- ダミー回帰用データ
dummy_dishonest_table <- dummy_all_data %>%
  group_by(category) %>%
  summarise(
    DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
    DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
    DQS_3 = sum(DQS_3 == 1, na.rm = TRUE),
    Or_DQS = sum(Or_DQS == 1, na.rm = TRUE)
  )

cat("=== ダミー回帰用データでの不真面目回答者数 ===\n")
print(dummy_dishonest_table)

# Or_DQS違反者数の棒グラフ
ggplot(dummy_dishonest_table, aes(x = category, y = Or_DQS)) +
  geom_bar(stat = "identity") +
  labs(title = "介入群別Or_DQS違反者数", 
       x = "介入群", y = "Or_DQS違反者数（人）")

# 真面目回答者数テーブル（介入群 × DQS指標）- ダミー回帰用データ
dummy_honest_table <- dummy_all_data %>%
  group_by(category) %>%
  summarise(
    DQS_1 = sum(DQS_1 == 0, na.rm = TRUE),
    DQS_2 = sum(DQS_2 == 0, na.rm = TRUE),
    DQS_3 = sum(DQS_3 == 0, na.rm = TRUE),
    Or_DQS = sum(Or_DQS == 0, na.rm = TRUE)
  )

cat("=== ダミー回帰用データでの真面目回答者数 ===\n")
print(dummy_honest_table)
```

## 介入群ごとのOr_DQS数と割合
```{r or-dqs-by-group}
# 介入群ごとのOr_DQS数と割合
or_dqs_summary <- dummy_all_data %>%
  group_by(category) %>%
  summarise(
    総数 = n(),
    Or_DQS_違反者数 = sum(Or_DQS == 1, na.rm = TRUE),
    Or_DQS_真面目者数 = sum(Or_DQS == 0, na.rm = TRUE),
    Or_DQS_違反率 = round(mean(Or_DQS, na.rm = TRUE) * 100, 2)
  ) %>%
  mutate(Or_DQS_違反率_表示 = paste0(Or_DQS_違反率, "%"))

cat("=== 介入群ごとのOr_DQS数と割合 ===\n")
print(or_dqs_summary)

# 表形式でも表示
or_dqs_summary %>%
  select(category, 総数, Or_DQS_違反者数, Or_DQS_違反率_表示) %>%
  kable(col.names = c("介入群", "総数", "Or_DQS違反者数", "Or_DQS違反率"),
        caption = "介入群ごとのOr_DQS違反者数と割合") %>%
  kable_styling()
```

## ダミー回帰用データでのDQS指標別違反者数の折れ線グラフ
```{r dummy-dqs-violation-plot}
# データ準備（違反者数をカウント）- ダミー回帰用データ
dummy_dqs_data <- dummy_all_data %>%
  group_by(category) %>%
  summarise(DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
            DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
            DQS_3 = sum(DQS_3 == 1, na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("DQS_"), names_to = "DQS", values_to = "count")

# 折れ線グラフ - ダミー回帰用データ
ggplot(dummy_dqs_data, aes(x = DQS, y = count, color = category, group = category)) +
  geom_line() + geom_point() +
  scale_y_continuous(limits = c(0, NA), breaks = seq(0, 200, 5)) +
  labs(x = "DQS指標", y = "違反者数（人）", color = "介入群") +
  theme(text = element_text(family = "HiraginoSans-W3"))
```

## ダミー回帰用データでのDQS1~3の違反者数推移グラフ
```{r dummy-dqs-trend-plot}
# DQS1~3の違反者数推移（全体）- ダミー回帰用データ
dummy_dqs_trend_data <- dummy_all_data %>%
  summarise(DQS_1 = sum(DQS_1 == 1, na.rm = TRUE),
            DQS_2 = sum(DQS_2 == 1, na.rm = TRUE),
            DQS_3 = sum(DQS_3 == 1, na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("DQS_"), names_to = "DQS", values_to = "count") %>%
  mutate(DQS = factor(DQS, levels = c("DQS_1", "DQS_2", "DQS_3")))

# 違反者数を確認
cat("=== ダミー回帰用データでのDQS指標別違反者数 ===\n")
print(dummy_dqs_trend_data)

# 棒グラフ（DQS1~3の推移）- ダミー回帰用データ
ggplot(dummy_dqs_trend_data, aes(x = DQS, y = count)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -1, color = "black", size = 4) +
  scale_y_continuous(limits = c(0, max(dummy_dqs_trend_data$count) * 1.1), breaks = seq(0, 200, 10)) +
  labs( 
       x = "DQS指標", y = "違反者数（人）") +
  theme(text = element_text(family = "HiraginoSans-W3"))
```

--- 

## ダミー回帰分析
### 共変量なしモデル
```{r dummy-regression}
# Or_DQSを従属変数としたダミー回帰分析（統制群を基準カテゴリとして使用）
model_or_dqs <- lm(Or_DQS ~ gain_emphasis + loss_aversion + pre_commitment + using_llm, 
                   data = dummy_all_data)

# 回帰結果の表示
summary(model_or_dqs)
```



# 共変量ありモデル
```{r}
# Model 1: ベースライン（共変量なし）- 統制群を基準
model1 <- lm(Or_DQS ~ gain_emphasis + loss_aversion + pre_commitment + using_llm, 
             data = dummy_all_data)

# Model 2: 人口統計学的変数（性別・年齢）を追加
model2 <- lm(Or_DQS ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age, 
             data = dummy_all_data)

# Model 3: さらに社会的変数（学歴・居住地）を追加  
model3 <- lm(Or_DQS ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age + player.q_education + player.q_area, 
             data = dummy_all_data)

# Model 4: デバイス情報も追加（フルモデル）
model4 <- lm(Or_DQS ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age + player.q_education + player.q_area + player.q_device, 
             data = dummy_all_data)
```

```{r}
# 日本語ラベルを設定した回帰結果表
tab_model(model1, model4, 
          show.aic = T,
          pred.labels = c(
            "(Intercept)" = "(Intercept)",
            "gain_emphasis" = "利得強調",
            "loss_aversion" = "損失回避", 
            "pre_commitment" = "事前申告",
            "using_llm" = "LLM活用",
            "player.q_gender" = "性別",
            "player.q_age" = "年齢",
            "player.q_education" = "学歴",
            "player.q_area" = "居住地",
            "player.q_device" = "デバイス"
          ),
          dv.labels = c("共変量なしモデル", "共変量ありモデル"),
          string.pred = "変数")
```

## Cohen's d 効果量の計算
```{r cohens-d-calculation}
# 統制群を基準としたCohen's dの計算
group_stats <- dummy_all_data %>%
  group_by(category) %>%
  summarise(
    mean_or_dqs = mean(Or_DQS, na.rm = TRUE),
    sd_or_dqs = sd(Or_DQS, na.rm = TRUE),
    n = n()
  )

# 統制群の値
control_mean <- group_stats$mean_or_dqs[group_stats$category == "統制群"]
control_sd <- group_stats$sd_or_dqs[group_stats$category == "統制群"]
control_n <- group_stats$n[group_stats$category == "統制群"]

# Cohen's d計算
cohens_d_results <- group_stats %>%
  filter(category != "統制群") %>%
  mutate(
    pooled_sd = sqrt(((control_n - 1) * control_sd^2 + (n - 1) * sd_or_dqs^2) / (control_n + n - 2)),
    cohens_d = (mean_or_dqs - control_mean) / pooled_sd
  ) %>%
  select(category, cohens_d) %>%
  mutate(cohens_d = round(cohens_d, 3))

kable(cohens_d_results, 
      col.names = c("介入群", "Cohen's d"),
      caption = "統制群を基準としたCohen's d効果量")
```

## DQSごとの分析
### DQS1
```{r}
# DQS_1を従属変数としたダミー回帰分析（統制群を基準カテゴリとして使用）
model_dqs1 <- lm(DQS_1 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm, 
                   data = dummy_all_data)

# 回帰結果の表示
summary(model_dqs1)
```

```{r}
# Model 4: デバイス情報も追加（フルモデル）
model4_dqs1 <- lm(DQS_1 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age + player.q_education + player.q_area + player.q_device, 
             data = dummy_all_data)

# 回帰結果の表示
summary(model4_dqs1)

tab_model(model_dqs1, model4_dqs1,
          show.aic = T,
          pred.labels = c(
            "(Intercept)" = "(Intercept)",
            "gain_emphasis" = "利得強調",
            "loss_aversion" = "損失回避", 
            "pre_commitment" = "事前申告",
            "using_llm" = "LLM活用",
            "player.q_gender" = "性別",
            "player.q_age" = "年齢",
            "player.q_education" = "学歴",
            "player.q_area" = "居住地",
            "player.q_device" = "デバイス"
          ),
          dv.labels = c("DQS1 共変量なしモデル", "DQS1 共変量ありモデル"),
          string.pred = "変数")
```


### DQS2
```{r}
# DQS_2を従属変数としたダミー回帰分析（統制群を基準カテゴリとして使用）
model_dqs2 <- lm(DQS_2 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm, 
                   data = dummy_all_data)

# 回帰結果の表示
summary(model_dqs2)
```

```{r}
# Model 4: デバイス情報も追加（フルモデル）
model4_dqs2 <- lm(DQS_2 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age + player.q_education + player.q_area + player.q_device, 
             data = dummy_all_data)

# 回帰結果の表示
summary(model4_dqs2)

tab_model(model_dqs2, model4_dqs2,
          show.aic = T,
          pred.labels = c(
            "(Intercept)" = "(Intercept)",
            "gain_emphasis" = "利得強調",
            "loss_aversion" = "損失回避", 
            "pre_commitment" = "事前申告",
            "using_llm" = "LLM活用",
            "player.q_gender" = "性別",
            "player.q_age" = "年齢",
            "player.q_education" = "学歴",
            "player.q_area" = "居住地",
            "player.q_device" = "デバイス"
          ),
          dv.labels = c("DQS2 共変量なしモデル", "DQS2 共変量ありモデル"),
          string.pred = "変数")
```

### DQS3
```{r}
# DQS_3を従属変数としたダミー回帰分析（統制群を基準カテゴリとして使用）
model_dqs3 <- lm(DQS_3 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm, 
                   data = dummy_all_data)

# 回帰結果の表示
summary(model_dqs3)
```

```{r}
# Model 4: デバイス情報も追加（フルモデル）
model4_dqs3 <- lm(DQS_3 ~ gain_emphasis + loss_aversion + pre_commitment + using_llm + 
             player.q_gender + player.q_age + player.q_education + player.q_area + player.q_device, 
             data = dummy_all_data)

# 回帰結果の表示
summary(model4_dqs3)

tab_model(model_dqs3, model4_dqs3,
          show.aic = T,
          pred.labels = c(
            "(Intercept)" = "(Intercept)",
            "gain_emphasis" = "利得強調",
            "loss_aversion" = "損失回避", 
            "pre_commitment" = "事前申告",
            "using_llm" = "LLM活用",
            "player.q_gender" = "性別",
            "player.q_age" = "年齢",
            "player.q_education" = "学歴",
            "player.q_area" = "居住地",
            "player.q_device" = "デバイス"
          ),
          dv.labels = c("DQS3 共変量なしモデル", "DQS3 共変量ありモデル"),
          string.pred = "変数")
```

--- 

## 分析のフロー

* **1. ライブラリの読み込み**

* **2. データ前処理**
    * **データの読み込み**: 5つの異なる実験条件（basic, gain_emphasis, loss_aversion, pre_commitment, using_llm）のCSVファイルをそれぞれ読み込む。
    * **データの加工**:
        * 各データセットから、分析に必要な列（参加者ID、デモグラフィック、BigFive尺度、陰謀論尺度、CRT尺度など）のみを抽出します。
        * どの実験条件のデータかを示す`category`列を各データセットに追加します。
    * **全データの結合**: 5つのデータフレームを縦に結合し、`all_data`という一つの大きなデータフレームを作成します (総計958行)。

* **3. 従属変数従属変数`Or_DQS`を作成**
    * **DQSダミー列の作成**: 3つの注意チェック質問（`player.big5_IMC`, `player.inboronIMC`, `player.crt_DQS`）の結果に基づき、不誠実回答のダミー変数（`DQS_1`, `DQS_2`, `DQS_3`）を作成（不真面目回答者なら1）
    * **統合DQS変数の作成**: 3つのDQSダミーのいずれか一つでも1（不真面目回答）の場合に1となる、主要な従属変数`Or_DQS`を作成。`Or_DQS`が1なら不真面目回答者と定義する。

* **4. 分析用データの準ダミー変数（説明変数）を作成**
    * **不完全回答の除外**: 途中で回答を中断した参加者（最後の設問`player.crt_rank`がNA）を除外 (除外後889行)。
    * **ダミー変数の作成**: 回帰分析のため、`category`列を基に各実験条件（`gain_emphasis`, `loss_aversion`など）のダミー変数（0または1）を作成。

* **5. 不真面目回答の割合、記述統計量の算出**
    * `不誠実回答の割合（`Or_DQS`など）について、実験条件ごとの数や割合、記述統計表を作成。
    * どの実験群も20%前後の不真面目回答がいた。先行研究を踏襲している

* **6. 回帰分析の実行**
    * **モデル1 (共変量なし)**: `Or_DQS`を従属変数、各実験カテゴリのダミー変数を独立変数として、線形回帰分析（`lm`）を実行します（`basic`カテゴリを基準）
    * **モデル2〜4 (共変量あり)**: 統制変数を段階的に投入したモデルを構築します。
        * **モデル2**: モデル1 + 人口統計変数（性別、年齢）
        * **モデル3**: モデル2 + 社会経済変数（学歴、居住地）
        * **モデル4**: モデル3 + デバイス情報
    * **モデル比較**: `sjPlot::tab_model`を使い、4つのモデルの回帰結果（係数、信頼区間、p値、AICなど）をまとめた比較表を出力。
    

### pre_commitment以外は負の効果（不真面目回答者の割合を下げる効果）があったが、p値は有意水準を満たさなかった。（5%水準）

### 損失回避フレーミングは4%不真面目回答者を下げることが示されたがp=0.338で統計的に優位な水準ではなかった。using_llmもほとんど効果がないことがtab_modelの出力からわかる


---

## ANOVA分析
### 実験条件間の群間比較
```{r anova-analysis}
# 一元配置分散分析（ANOVA）
# H0: すべての実験条件で不真面目回答率に差がない
# H1: 少なくとも一つの実験条件で不真面目回答率に差がある

model1 <- lm(Or_DQS ~ category, 
             data = dummy_all_data)

anova_result_model1 <- anova(model1) %>%
  tidy()

#出力結果
anova_result_model1
```


```{r}
# ANOVA結果をHTMLテーブルで出力（日本語版）
anova_result_model1 %>%
  mutate(term = case_when(
    term == "category" ~ "実験条件",
    term == "Residuals" ~ "残差",
    TRUE ~ term
  )) %>%
  kable(format = "html", 
        caption = "一元配置分散分析結果（実験条件間の比較）",
        col.names = c("要因", "自由度", "平方和", "平均平方", "F値", "p値")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


```{r anova-model4}
# 共変量を考慮したANOVA分析（model4と同じモデル式）
# フルモデル（すべての共変量を含む）でのANOVA

model4 <- lm(Or_DQS ~ category + 
                   player.q_gender + player.q_age + player.q_education + player.q_area + player.q_device, 
                   data = dummy_all_data)

anova_result_model4 <- anova(model4) %>%
  tidy()
``` 

```{r}
# ANOVA結果をHTMLテーブルで出力（日本語版・共変量あり）
anova_result_model4 %>%
  mutate(term = case_when(
    term == "category" ~ "実験条件",
    term == "player.q_gender" ~ "性別",
    term == "player.q_age" ~ "年齢", 
    term == "player.q_education" ~ "学歴",
    term == "player.q_area" ~ "居住地",
    term == "player.q_device" ~ "デバイス",
    term == "Residuals" ~ "残差",
    TRUE ~ term
  )) %>%
  kable(format = "html", 
        caption = "共変量を考慮した分散分析結果",
        col.names = c("要因", "自由度", "平方和", "平均平方", "F値", "p値")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
``` 

## DQS指標間同質性検定（カイ二乗検定）
**帰無仮説（H₀）**: DQS1、DQS2、DQS3の違反パターンは同質である（真面目・不真面目の分布に差がない）  
**対立仮説（H₁）**: DQS1、DQS2、DQS3の違反パターンは同質でない（真面目・不真面目の分布に差がある）

```{r dqs-homogeneity-test}
# ダミー回帰用データを使用（既にNAが除外されている）
clean_data <- dummy_all_data

# DQS指標別の違反者数を集計
dqs_counts <- clean_data %>%
  summarise(
    DQS_1_honest = sum(DQS_1 == 0, na.rm = TRUE),
    DQS_1_dishonest = sum(DQS_1 == 1, na.rm = TRUE),
    DQS_2_honest = sum(DQS_2 == 0, na.rm = TRUE),
    DQS_2_dishonest = sum(DQS_2 == 1, na.rm = TRUE),
    DQS_3_honest = sum(DQS_3 == 0, na.rm = TRUE),
    DQS_3_dishonest = sum(DQS_3 == 1, na.rm = TRUE)
  )

# クロス集計表の作成（行：真面目/不真面目、列：DQS1/DQS2/DQS3）
crosstab_matrix <- matrix(c(
  dqs_counts$DQS_1_honest, dqs_counts$DQS_2_honest, dqs_counts$DQS_3_honest,
  dqs_counts$DQS_1_dishonest, dqs_counts$DQS_2_dishonest, dqs_counts$DQS_3_dishonest
), nrow = 2, byrow = TRUE)

rownames(crosstab_matrix) <- c("真面目回答", "不真面目回答")
colnames(crosstab_matrix) <- c("DQS_1", "DQS_2", "DQS_3")

cat("=== DQS指標間同質性検定のクロス集計表 ===\n")
cat("行：回答態度、列：DQS指標\n\n")
print(crosstab_matrix)

# カイ二乗検定の実行
chi_test_homogeneity <- chisq.test(crosstab_matrix)

cat("\n=== 検定結果 ===\n")
cat("カイ二乗統計量:", round(chi_test_homogeneity$statistic, 4), "\n")
cat("p値:", round(chi_test_homogeneity$p.value, 4), "\n")
cat("自由度:", chi_test_homogeneity$parameter, "\n")

# 期待度数の表示
cat("\n=== 期待度数 ===\n")
print(round(chi_test_homogeneity$expected, 2))

# 残差の表示
cat("\n=== 標準化残差 ===\n")
print(round(chi_test_homogeneity$residuals, 3))
```



## 不真面目回答者のみでの同質性検定
**帰無仮説（H₀）**: 不真面目回答者において、DQS1、DQS2、DQS3の違反数は同質である  
**対立仮説（H₁）**: 不真面目回答者において、DQS1、DQS2、DQS3の違反数は同質でない

```{r dishonest-only-homogeneity-test}
# 不真面目回答者のみの違反数を集計
dishonest_counts <- clean_data %>%
  summarise(
    DQS_1_dishonest = sum(DQS_1 == 1, na.rm = TRUE),
    DQS_2_dishonest = sum(DQS_2 == 1, na.rm = TRUE),
    DQS_3_dishonest = sum(DQS_3 == 1, na.rm = TRUE)
  )

# 不真面目回答者数のベクトル作成
dishonest_vector <- c(
  dishonest_counts$DQS_1_dishonest, 
  dishonest_counts$DQS_2_dishonest, 
  dishonest_counts$DQS_3_dishonest
)
names(dishonest_vector) <- c("DQS_1", "DQS_2", "DQS_3")

cat("=== 不真面目回答者数（DQS指標別） ===\n")
print(dishonest_vector)

# 適合度検定（各DQS指標で同じ違反数が期待される）
chi_test_dishonest_only <- chisq.test(dishonest_vector)

cat("\n=== 不真面目回答者のみでの同質性検定結果 ===\n")
cat("カイ二乗統計量:", round(chi_test_dishonest_only$statistic, 4), "\n")
cat("p値:", round(chi_test_dishonest_only$p.value, 4), "\n")
cat("自由度:", chi_test_dishonest_only$parameter, "\n")

# 期待度数の表示
cat("\n=== 期待度数（各DQS指標で同数の違反を仮定） ===\n")
print(round(chi_test_dishonest_only$expected, 2))

# 残差の表示
cat("\n=== 残差（観測値 - 期待値） ===\n")
residuals_dishonest <- dishonest_vector - chi_test_dishonest_only$expected
print(round(residuals_dishonest, 2))

# 各DQS指標の違反率
total_n <- nrow(clean_data)
violation_rates <- round(dishonest_vector / total_n * 100, 2)
cat("\n=== DQS指標別違反率 ===\n")
for(i in 1:3) {
  cat(names(violation_rates)[i], ":", violation_rates[i], "%\n")
}
```

## DQS指標間同質性検定結果のまとめ
```{r chi-square-interpretation}
# 違反者数の表（真面目回答・不真面目回答の数）
violation_count_homogeneity <- data.frame(
  項目 = c("DQS_1 真面目回答", "DQS_1 不真面目回答",
           "DQS_2 真面目回答", "DQS_2 不真面目回答", 
           "DQS_3 真面目回答", "DQS_3 不真面目回答"),
  値 = c(dqs_counts$DQS_1_honest, dqs_counts$DQS_1_dishonest,
         dqs_counts$DQS_2_honest, dqs_counts$DQS_2_dishonest,
         dqs_counts$DQS_3_honest, dqs_counts$DQS_3_dishonest)
)

kable(violation_count_homogeneity, caption = "DQS指標別回答者数")

# 検定結果の表
homogeneity_test_results <- data.frame(
  項目 = c("カイ二乗統計量", "自由度", "p値", "判定"),
  値 = c(round(chi_test_homogeneity$statistic, 3),
         chi_test_homogeneity$parameter,
         format(chi_test_homogeneity$p.value, scientific = TRUE, digits = 3),
         ifelse(chi_test_homogeneity$p.value < 0.05, "有意", "非有意"))
)

kable(homogeneity_test_results, caption = "DQS指標間同質性検定結果")
```

## 不真面目回答者のみでの同質性検定結果まとめ
```{r dishonest-only-interpretation}
# 違反者数の表
violation_count_data <- data.frame(
  値 = c(dishonest_vector[1], dishonest_vector[2], dishonest_vector[3])
)

kable(violation_count_data, caption = "DQS指標別違反者数")

# 検定結果の表
test_result_data <- data.frame(
  項目 = c("カイ二乗統計量", "自由度", "p値"),
  値 = c(round(chi_test_dishonest_only$statistic, 3),
         chi_test_dishonest_only$parameter,
         format(chi_test_dishonest_only$p.value, scientific = TRUE, digits = 3))
)

kable(test_result_data, caption = "DQSごとの不真面目回答者数に関するχ自乗検定")
```

## 介入群×DQS指標のクロス集計における検定
**帰無仮説（H₀）**: 介入群とDQS指標の違反パターンは独立である  
**対立仮説（H₁）**: 介入群とDQS指標の違反パターンは独立でない

```{r intervention-dqs-crosstab-test}
# 介入群×DQS指標の不真面目回答者数のクロス集計表を作成
intervention_dqs_crosstab <- clean_data %>%
  select(category, DQS_1, DQS_2, DQS_3) %>%
  pivot_longer(cols = starts_with("DQS_"), names_to = "DQS_indicator", values_to = "violation") %>%
  filter(violation == 1) %>%  # 不真面目回答者のみ
  count(category, DQS_indicator) %>%
  pivot_wider(names_from = DQS_indicator, values_from = n, values_fill = 0)

# クロス集計表をマトリックス形式に変換
crosstab_matrix_intervention <- as.matrix(intervention_dqs_crosstab[,-1])
rownames(crosstab_matrix_intervention) <- intervention_dqs_crosstab$category


print(crosstab_matrix_intervention)

# カイ二乗検定の実行
chi_test_intervention_dqs <- chisq.test(crosstab_matrix_intervention)


cat("カイ二乗統計量:", round(chi_test_intervention_dqs$statistic, 4), "\n")
cat("p値:", round(chi_test_intervention_dqs$p.value, 4), "\n")
cat("自由度:", chi_test_intervention_dqs$parameter, "\n")

# 期待度数の表示
cat("\n=== 期待度数 ===\n")
print(round(chi_test_intervention_dqs$expected, 2))

# 標準化残差の表示
cat("\n=== 標準化残差 ===\n")
print(round(chi_test_intervention_dqs$residuals, 3))

# 検定結果の表
intervention_dqs_test_results <- data.frame(
  項目 = c("カイ二乗統計量", "自由度", "p値", "判定"),
  値 = c(round(chi_test_intervention_dqs$statistic, 3),
         chi_test_intervention_dqs$parameter,
         format(chi_test_intervention_dqs$p.value, scientific = TRUE, digits = 3),
         ifelse(chi_test_intervention_dqs$p.value < 0.05, "有意", "非有意"))
)

kable(intervention_dqs_test_results, caption = "介入群×DQS指標の独立性検定結果")
```

## 可視化
```{r}

```

